<nav class="navbar navbar-expand-lg navbar" style="background-color: #0e2238">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"
      ><img
        width="40"
        height="40"
        src="https://img.icons8.com/3d-fluency/94/group--v1.png"
        alt="globe-africa"
    /></a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active text-light" aria-current="page" href="/"
            >Home</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link text-light" href="/about">About</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link text-light" href="/todo">Todo</a>
        </li> -->
      </ul>
      <div class="d-flex">
        <!-- <input
          class="form-control me-2"
          type="search"
          placeholder="Search"
          aria-label="Search"
        /> -->
        <div id="root">
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="modal fade" id="loginModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="login-form">
          <div class="mb-3">
              <label for="email" class="form-label">Email address</label>
              <input type="email" class="form-control" id="email" placeholder="Enter email">
              <div id="emailError" class="text-danger"></div>
          </div>
          <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="Password">
              <div id="passwordError" class="text-danger"></div>
          </div>
          <div class="mb-3 d-flex">
              <a class="text-primary" href="/forgetPassword">Forgot password</a>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="login" onclick="login()">Login</button>
      </div>
    </div>
  </div>
</div>

<script>

    let dropdownVisible = false;

    function toggleDropdown() {
        const dropdownMenu = document.getElementById('dropdownMenu');
        dropdownVisible = !dropdownVisible;
        dropdownMenu.style.display = dropdownVisible ? 'block' : 'none';
    }
    showProfile();
    async function showProfile(){
      const token = localStorage.getItem('token');
      if(localStorage.getItem('token')){
        try {
          const resData = await fetch("/getuser",{
            method:'GET',
            headers:{
              'Content-Type':'application/json',
              'Authorization':`Bearer ${token}`
            }
          });

          const resjson = await resData.json();

          const template = `
          <div class="dropdown">
            <img src='${resjson.data[0].userProfile}' height='40px' width='50px' style='border-radius: 50%;cursor: pointer;' onclick="toggleDropdown()"/>
            <div id="dropdownMenu" class="dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0;">
              <a class="dropdown-item" href="/userProfile">View Profile</a>
              <a class="dropdown-item" href="#" onclick="logout()">Logout</a>
            </div>
          </div>
          `

          document.getElementById('root').innerHTML = template;
        } catch (error) {
          console.log("Error to find profile picture : ",error)
        }
        
      }else{
        document.getElementById('root').innerHTML = `<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModel">login</button>`
      }
    }

    function logout() {
        localStorage.removeItem('token');
        location.reload();
    }


    function login(){
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;

        if(email == ""  || password == ""){
            return Swal.fire({
                title: "Oops...",
                text: "All fileds are required.",
                icon: "error"
            });
        }
        const apiData = new FormData();
        apiData.append('email', email);
        apiData.append('password', password);

        fetch('/userlogin', {
            method: 'POST',
            body: apiData,
        })
        .then(function (response) {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(function (result) {
            if (result.available) {
              return Swal.fire({
                icon: 'success',
                text:"Login Successfulll."
              }).then((data)=>{
                if(data.isConfirmed){
                  localStorage.setItem('token',result.token)
                  location.reload();
                }
              })
            }else{
                Swal.fire({
                    title: "Oops...",
                    text: "Login failed. Invalid email and password ",
                    icon: "error"
                });
            }
        })
        .catch(function (error) {
            console.error("Login failed:", error);
            Swal.fire({
                title: "Oops...",
                text: "Login failed. Please try again later.",
                icon: "error"
            });
        });
    }
</script>