<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <%- include('../../partials/link.ejs') %>
    <style>
        body{
            font-family: 'Times New Roman', Times, serif;
        }
    </style>
</head>
<body>

    <!-- Model for add address -->

    <div class="modal fade" id="addAddress" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add delivery address</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
              <div class="modal-body">
                <div id="">
                    <div class="mb-3">
                        <label for="street" class="form-label">Street Name :</label>
                        <input type="text" class="form-control" id="street" placeholder="Enter street  name">
                        <div id="nameError" class="text-danger"></div>
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Building No :</label>
                        <input type="text" class="form-control" id="building" placeholder="Enter building no">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Area / Vilage Name:</label>
                        <input type="text" class="form-control" id="area" placeholder="Enter Area / Vilage Name : ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Pinccode :</label>
                        <input type="number" class="form-control" id="pincode" placeholder="Enter pincode">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">City :</label>
                        <input type="text" class="form-control" id="city" placeholder="Enter city name: ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">State :</label>
                        <input type="text" class="form-control" id="state" placeholder="Enter state name: ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Famous place nearest you :</label>
                        <input type="text" class="form-control" id="famousplace" placeholder="Enter Famous place nearest you">
                    </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addAddress()">Save address</button>
            </div>
          </div>
        </div>
    </div>

    <!-- End of add address model -->

    <!-- Model for edit address -->

    <div class="modal fade" id="editAddress" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">edit delivery address</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
              <div class="modal-body">
                <div id="">
                    <div class="mb-3">
                        <label for="street" class="form-label">Street Name :</label>
                        <input type="text" class="form-control" id="street1" placeholder="Enter street name">
                        <div id="nameError" class="text-danger"></div>
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Building No :</label>
                        <input type="text" class="form-control" id="building1" placeholder="Enter building no">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Area / Vilage Name:</label>
                        <input type="text" class="form-control" id="area1" placeholder="Enter Area / Vilage Name : ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Pinccode :</label>
                        <input type="number" class="form-control" id="pincode1" placeholder="Enter pincode">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">City :</label>
                        <input type="text" class="form-control" id="city1" placeholder="Enter city name: ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">State :</label>
                        <input type="text" class="form-control" id="state1" placeholder="Enter state name: ">
                    </div>
                    <div class="mb-3">
                        <label for="" class="form-label">Famous place nearest you :</label>
                        <input type="text" class="form-control" id="famousplace1" placeholder="Enter Famous place nearest you">
                    </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="handleAddressEdit()">Apply changes</button>
            </div>
          </div>
        </div>
    </div>

    <!-- End of the edit address -->

    <h1 class="border mt-2 container p-2 text-center text-light shadow-sm rounded-4" style="background-color: rgba(11, 1, 1, 0.562);">Order Summary</h1>

    <div class="container">
        <div class="row">
            <div class="col-md-12 mt-2 shadow-sm rounded-4 border bg-light">
                <div class="p-2" id="addressPart">
                    
                </div>
            </div>
            <div id="mainRoot">
                <div class="col-md-12 mt-2 text-center">
                    <div class="p-2 table-responsive-sm" id="vieworder">
                        
                    </div>
                </div>
                <div class="col-md-12 mt-1">
                    <div class="d-flex justify-content-end">
                        <p style="font-size: large;margin-right: 32px;" class="border p-2 bg-light"><b>Total : </b>â‚¹<span id="totalAmount"></span></p>
                    </div>
                </div>
                <div class="col-md-12 mt-1 form-group">
                    <p class="shadow-sm rounded-4 border bg-light p-2" style="font-size: large;">Select your payment method : <select class="form-control" id="selectMethod" onchange="paymentMethod()"><option value=""></option> <option value="cashondelivery">Cash on delivery</option> <option value="paywithcard">Pay with card</option> </select> </p>
                </div>
                <div class="col-md-12 mt-1 mb-3" id="paymentOption">

                </div>
            </div>
        </div>
    </div>
</body>
<script>
    function paymentMethod(){
        let payment = document.getElementById("selectMethod").value;

        if(payment == 'paywithcard'){
            $("#paymentOption").html(`<button class='btn btn-primary' onclick='placeorderWithCard()'>pay with card</button>`);
        }else{
            $("#paymentOption").html(`<button class='btn btn-primary' onclick='placeorder()'>Confirm placeorder</button>`);
        }
        
    }
</script>
<script>

    // for the order

    async function placeorderWithCard(){

    }

    async function placeorder(){
        const token = localStorage.getItem('token');
        
        Swal.fire({
            title: "Are you sure to place order with Cash on delivery?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "placeorder!"
        }).then(async(result) => {
            if (result.isConfirmed) {

                const order = await fetch("/order",{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization":`Bearer ${token}`
                    }
                })

                const orderJSON = await order.json();

                if(orderJSON.success){
                    return Swal.fire({
                        title: "Success!",
                        text: "Your order is successfully placed.",
                        icon: "success"
                    }).then((result)=>{
                        if(result.isConfirmed){
                            window.location.href = "/viewProduct";
                        }
                    })
                }

            }
        });

        


    }

    getOrders();

    async function getOrders(){
        const cart = await fetch("/getcartitem",{
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization":`Bearer ${localStorage.getItem('token')}`
            }
        })

        const item = await cart.json();

        let no = 0;

        let html = `<table class='table'><thead><th>No</th><th>ProductName</th><th>product_picture</th><th>Price</th><th>quantity</th><th>subtotal</th><tbody>`;

        let total = 0;

        item.data.map((data)=>{
            
            total += data.subtotal;

            html += `
                <tr>
                    <td>${no++}</td>
                    <td>${data.productName}</td>
                    <td><img height='50px' width='50px' src='${data.product_picture}'/></td>
                    <td>${data.price}</td>
                    <td>${data.quantity}</td>
                    <td>${data.subtotal.toFixed(2)}</td>
                <tr/>
            `
        })

        html+=`</tbody></table>`;

        $("#vieworder").html(html);
        $("#totalAmount").text(total.toFixed(2));
    }


    // for add address

    async function handleAddressEdit(){

        const street = document.getElementById('street1').value;
        const building = document.getElementById('building1').value;
        const pincode = document.getElementById('pincode1').value;
        const city = document.getElementById('city1').value;
        const state = document.getElementById('state1').value;
        const famousplace = document.getElementById('famousplace1').value;
        const area = document.getElementById('area1').value;

        const formData = new FormData();
        formData.append('street',street);
        formData.append('building',building);
        formData.append('area',area);
        formData.append('pincode',pincode);
        formData.append('city',city);
        formData.append('state',state);
        formData.append('famousplace',famousplace);

        const resAdd = await fetch("/address",{
            method:"PATCH",
            headers:{
                "Authorization":`Bearer ${localStorage.getItem('token')}`
            },
            body:formData
        });

        const data = await resAdd.json();

        if(data.success){
            return Swal.fire({
                icon: 'success',
                title: 'Address is updated successfully',
                showConfirmButton: true,
            }).then((result) => {
                location.reload();  
            })
        }
    }

    function editAddress(item){
        document.getElementById('street1').value = item.street;
        document.getElementById('building1').value = item.building;
        document.getElementById('pincode1').value = item.pincode;
        document.getElementById('city1').value = item.city;
        document.getElementById('state1').value = item.state;
        document.getElementById('famousplace1').value = item.famousplace;
        document.getElementById('area1').value = item.area;
    }


    async function addAddress(){
        const street = document.getElementById('street').value;
        const building = document.getElementById('building').value;
        const pincode = document.getElementById('pincode').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const famousplace = document.getElementById('famousplace').value;
        const area = document.getElementById('area').value;

        const formData = new FormData();
        formData.append('street',street);
        formData.append('building',building);
        formData.append('area',area);
        formData.append('pincode',pincode);
        formData.append('city',city);
        formData.append('state',state);
        formData.append('famousplace',famousplace);

        const resAdd = await fetch("/address",{
            method:"POST",
            headers:{
                "Authorization":`Bearer ${localStorage.getItem('token')}`
            },
            body:formData
        });

        const data = await resAdd.json();

        if(data.success){
            return Swal.fire({
                icon: 'success',
                title: 'Address added successfully',
                showConfirmButton: true,
            }).then((result) => {
                location.reload();  
            })
        }
    }


    // for display address

    displayAddress();
    async function displayAddress() { 

        const token = localStorage.getItem('token');

        const fetchAddress = await fetch("/address",{
            method:"GET",
            headers:{
                "Content-Type":"application/json",
                "Authorization":`Bearer ${token}`
            }
        })

        const resJSON = await fetchAddress.json();

        if(resJSON.data.length === 0){
            $("#mainRoot").html('');
            let html = `<center><button class='btn btn-primary' data-bs-toggle="modal" data-bs-target="#addAddress">+ Add address</button></center>`
            $("#addressPart").html(html);
        }else{

            const item = resJSON.data[0];

            let html = 
            `<p><strong class='border bg-success p-1 rounded text-light'>Deliver To :</strong>
            ${item.building}, ${item.street}, ${item.area}, ${item.city}, ${item.state}, pincode :${item.pincode}    
            </p>
            <p><strong>Famous place nearest to you : - </strong>${item.famousplace}</p>
            <button class='btn btn-primary' data-bs-toggle="modal" data-bs-target="#editAddress" onclick='editAddress(${JSON.stringify(item)})'>Edit Address</button>
            `;

            $("#addressPart").html(html);
        }

    }
</script>
</html>